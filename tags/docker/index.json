[
    {
        "ref": "https://harrylee.me/blog/2016-08-23-docker-docker-swarm-with-docker-machine-quick-setup-guide/",
        "title": "Docker: Docker Swarm with Docker Machine Quick Setup Guide",
        "section": "blog",
        "tags": ["docker","azure"],
        "date" : "2016.08.23",
        "body": "Docker already has an official documentation with tutorials and examples on how to go about setting up your own Docker Swarm nodes and cluster. This post is intended for those who have a fundamental grasp on Docker and are too lazy to read the documents. This post includes minimal explanation and focuses primarily on the configuration. It is written to be a series of instructions rather than a full fledged post.\nIntroduction This post outlines the set up of docker-machine to provision remote hosts (Generic and Microsoft Azure). Docker Swarm set up with and without docker-machine is also discussed.\nDocker Machine (Azure)\nDocker Machine (Generic)\nDocker Swarm (Generic)\nDocker Machine Swarm (Generic)\n Docker Machine (Azure) To use Docker Machine to provision hosts on Micorsoft Azure, first make sure that you have the correct subscription ID for your Azure account.\nExecute:\n$ docker-machine create --driver azure \\  --azure-subscription-id xxxx-xxxx-xxxx-xxxx \\  --azure-image canonical:UbuntuServer:16.04.0-LTS:latest \\  --azure-location eastus \\  --azure-resource-group DockerSwarm \\  --azure-size Basic_A0 \\  --azure-open-port 80 \\  dockertemp1 To get the latest osImage for the VM, use Azure CLI and execute:\n$ azure vm image list-skus This will return :\ninfo: Executing command vm image list-skus Location: eastus Publisher: canonical Offer: ubuntuserver + Getting virtual machine image skus (Publisher:\u0026#34;canonical\u0026#34; Offer:\u0026#34;ubuntuserver\u0026#34; Location:\u0026#34;eastus\u0026#34;) data: Publisher Offer sku Location data: --------- ------------ ----------------- -------- data: canonical ubuntuserver 12.04.2-LTS eastus data: canonical ubuntuserver 12.04.3-LTS eastus data: canonical ubuntuserver 12.04.4-LTS eastus data: canonical ubuntuserver 12.04.5-DAILY-LTS eastus data: canonical ubuntuserver 12.04.5-LTS eastus data: canonical ubuntuserver 12.10 eastus data: canonical ubuntuserver 14.04-beta eastus  With Azure, the network security group needs to be configured to open port 2376 to any internal port. The Azure driver should handle this for you.\n Docker Machine (Generic) If you already have a host that is running docker and you want to incorporate it into your docker-machine routine. This section is for you.\nWe need to establish a communication channel first. This part is a bit tricky since we are using SSH as the protocol for communication. You will need to make sure that the machines can talk to each other using SSH.\nIn some cases, you may have to disable login using a password option for the machines. You should try this when you get i/o timeout or similar errors regarding communication issues.\n The machine that is doing the deploying will be referred to as the deployment machine and the machine that is going to be deployed is the host.\n $ docker-machine create \\  --driver generic \\  --generic-ip-address=​\u0026lt;ip address\u0026gt;​ \\  --generic-ssh-key ~/.ssh/id_rsa \\  --generic-ssh-user dockeruser \\  --generic-ssh-port 22 ​\\  \u0026lt;machine name\u0026gt;  ip address is the public ip address of the host. machine name is the name that you give to your docker machine. the ssh public key used is the one in the default location: ~/.ssh/id_rsa.  The docker-machine communicates with the host via port 2376 (default). Ensure that this port is open and not blocked by your firewall.\n  Docker Swarm (Generic) Below describes the two methods to create a swarm (generic driver) without using Docker Machine.\nToken Method Hosted Discovery Backend Method (Consul)\n Token To install Swarm on the swarm master:\n$ docker run --rm swarm create Take note of the last line which is a token (cluster ID). Copy to a secure location. It will look something like: 81a20406f6258ab0cad7ceb5768daeac.\nThen install Swarm on the other nodes (hosts):\n$ docker run -d \\  --restart=always swarm join \\  --addr=\u0026lt;ip address\u0026gt;:2376 \\  token://\u0026lt;token\u0026gt;  ip address is the IP address of THIS node. token is the token that was generated from the previous step on the swarm master.  Do the same for every host.\nTo manage the swarm from the Swarm master:\n$ docker run -d swarm manage token://\u0026lt;token\u0026gt; To see if the nodes are connected in the swarm:\n$ docker run --rm swarm list token://\u0026lt;token\u0026gt;  Hosted Discovery Backend Install Consul If using the token method is not desired, you can use your own discovery key store. Consul can be used as a key:value store which will act as our discovery backend service. Normally this should be on an independent node, so that downtime of your cluster does not bring down this service too.\nSet up Consul:\n$ docker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap  This will start a Consul container that exposes port 8500 for the service.  Now we can use Consul to keep track of all the nodes in the swarm instead of the token.\nJoin Swarm Now we need to add all nodes into the swarm. On each node/host, run:\n$ docker run -d \\  --restart=always \\  --name swarm-agent swarm:1.0.0 join \\  --advertise \u0026lt;node ip\u0026gt;:2376 \\  consul://\u0026lt;consul ip\u0026gt;:8500  node ip is the IP address of the host/node. consul ip is the IP address of the node that is running Consul.  Swarm Master Once all nodes are added to the swarm, we need a way to control and manage the nodes. Swarm master does exactly this. Run swarm master on an existing node or an independent node (recommended).\nTo configure the Swarm master:\n$ docker run -d \\  --restart=always \\  --name swarm-agent-master \\  --tlsverify \\  --tlscacert=/etc/docker/ca.pem \\  --tlscert=/etc/docker/server.pem \\  --tlskey=/etc/docker/server-key.pem \\  --strategy spread \\  -p 3376:3376 \\  -v /etc/docker:/etc/docker swarm:1.0.0 manage \\  -H tcp://0.0.0.0:3376 \\  consul://\u0026lt;consul ip\u0026gt;:8500  where the Swarm master is exposed on port 3376  --tlsverify uses TLS, encrypted communication  --tlscacert --tlscert --tlskey ensure that these SSL certificates exist in the directory   -H tcp://0.0.0.0:3376 means that you can access the swarm master on the same node that it has been started.   consul ip is the IP address of the node that is running Consul.    To attach to the Swarm master:\n$ docker -H tcp://\u0026lt;ip address\u0026gt;:3376 info You can change the DOCKER_HOST environment variable if you don\u0026rsquo;t want to type -H \u0026lt;ip address\u0026gt;:\u0026lt;port\u0026gt; all the time.\n$ export DOCKER_HOST=tcp://\u0026lt;ip address\u0026gt;:3376  Docker Machine Swarm (Generic) This section outlines the creation of a swarm using Docker Machine. You should have a discovery backend configured before starting this section. See Hosted Discovery Backend on how to configure a Consul discovery backend.\nTo configure the Swarm Master:\ndocker-machine create \\ --driver generic \\ --generic-ip-address=​\u0026lt;ip address\u0026gt;​ \\ --generic-ssh-key ~/.ssh/id_rsa \\ --generic-ssh-user dockeruser \\ --generic-ssh-port 22 ​\\ --swarm --swarm-master --swarm-discovery=\u0026lt;consul\u0026gt; \\ --engine-opt=\u0026#34;cluster-store=\u0026lt;consul\u0026gt;\u0026#34; \\ --engine-opt=\u0026#34;cluster-advertise=\u0026lt;ip address\u0026gt;:2376\u0026#34; \u0026lt;machine name\u0026gt;  consul can be \u0026quot;$(docker-machine ip \u0026lt;consul name\u0026gt;):\u0026lt;consul port\u0026gt;\u0026quot;  consul name is the docker name that you have given your consul node consul port is the consul service port: 8500    To configure the Swarm Agent (simply remove --swarm-master):\ndocker-machine create \\ --driver generic \\ --generic-ip-address=​\u0026lt;ip address\u0026gt;​ \\ --generic-ssh-key ~/.ssh/id_rsa \\ --generic-ssh-user dockeruser \\ --generic-ssh-port 22 ​\\ --swarm --swarm-discovery=\u0026lt;consul\u0026gt; \\ --engine-opt=\u0026#34;cluster-store=\u0026lt;consul\u0026gt;\u0026#34; \\ --engine-opt=\u0026#34;cluster-advertise=\u0026lt;ip address\u0026gt;:2376\u0026#34; \u0026lt;machine name\u0026gt; When you run docker-machine ls, you should now see some values in the swarm column:\nNAME ACTIVE DRIVER STATE URL SWARM DOCKER ERRORS dockera - generic Running tcp://40.76.49.229:2376 dockera (master) v1.11.1 dockerb * generic Running tcp://40.76.35.249:2376 dockera v1.11.1 dockerconsul - generic Running tcp://104.41.139.22:2376 v1.11.1 Network Since we have the nodes setup in a swarm, we need to configure Docker Multi-Host Network. This is relatively easy if you have the swarm setup using Docker Machine.\n Set your docker machine to point to swarm master:  $ eval $(docker-machine env --swarm dockera)  Check if you are in the swarm environment by executing docker info, you should see all the connected nodes.\n  Create your overlay network:\n$ docker network create \\ --driver overlay \\ --subnet 10.0.9.0/24 \u0026lt;network name\u0026gt;  always define your subnet, you do not want any conflicts with the existing network that the node is connected to.    Check the network: docker network ls. Your newly created network should be listed.\n  Switch to each swarm agent and run the same command to ensure that all agents are connected to the network.\n  Conclusion Following the above set up yields a simple Docker Swarm cluster. There are easier ways to set up clusters such as using Docker Cloud and Amazon Container Services, but that is beside the point of this post. Setting up a Docker cluster this way allows us to learn by delving into the specifics and get our hands dirty with the internal workings of Docker!\n"
    }
,
    {
        "ref": "https://harrylee.me/blog/2016-06-25-docker-create-your-own-ipsec-l2tp-vpn-container/",
        "title": "Docker: Create your own IPsec/L2TP VPN container",
        "section": "blog",
        "tags": ["docker","vpn","network"],
        "date" : "2016.06.25",
        "body": "To configure your own VPN hosted on your own VPS is not difficult at all, especially when there are numerous configuration scripts lying around the internet. We will set up such a VPN using Docker hosted on a Microsoft Azure VM.\nSet Up Listed below is my set up. You don\u0026rsquo;t have to use the exact set up as me, as the configurations should be the same with any VM (Virtual Machine) running Docker (that\u0026rsquo;s the beauty of Docker!).\n Azure VM running Ubuntu 16.04 Xenial  The size of the Virtual Machine does not matter, so you can choose the cheapest one. You can use other Linux distributions, supported ones are:  Ubuntu 16.04, 14.04, 12.04 Debian 8 Jessie CentOS 7, 6     VM has Port 4500 and 500 open for UDP connections. Latest docker-engine installed Using the IPsec VPN Server on Docker Docker image  Configuration The configuration is extremely simple. You literally just follow the instructions listed on IPsec VPN Server on Docker. I shall summarise it below. The below instructions should be executed on the VM and I assume that you have the set up mentioned above.\n  Pull the image\n$ docker pull hwdsl2/ipsec-vpn-server   Create an environment file in your home directory e.g. (/home/dockeruser/vpn.env) with the following content:\nVPN_IPSEC_PSK=\u0026lt;IPsec pre-shared key\u0026gt; VPN_USER=\u0026lt;VPN Username\u0026gt; VPN_PASSWORD=\u0026lt;VPN Password\u0026gt;   DO NOT put single or double quotes around values, or add space around =. Also, DO NOT use these characters within values: \\ \u0026quot; '\n  Load the IPsec NETKEY kernel module:\n$ sudo modprobe af_key   Change directory to your home directory and execute below:\n$ docker run \\  --name ipsec-vpn-server \\  --env-file ./vpn.env \\  -p 500:500/udp \\  -p 4500:4500/udp \\  -v /lib/modules:/lib/modules:ro \\  -d --privileged \\  hwdsl2/ipsec-vpn-server   Now you have a running VPN!\n  Ports You have to remember to open up the ports (500/UDP and 4500/UDP) in order for this to work. I will describe how to do this for Azure VMs using the Network Security Group settings.\nThe following configuration assumes that your VM was created using Resource Manager and not Classic.\n   In your VM instance, select Settings-\u0026gt;Network interfaces-\u0026gt;Your VM interface.\n  In the Network Interface, select Settings-\u0026gt;Network security group-\u0026gt;Your VM network security group. There should just be one by default.\n  In the Network Security Group, select Settings-\u0026gt;Inbound security rules-\u0026gt;Your rules\n  Add the two ports to your inbound rules: 500/UDP and 4500/UDP\n  Conclusion Now you can go ahead and connect to your newly configured VPN! You can restart or stop your container at any time if you do not want to incur costs when you are not using it. This can all be achieved with one command thanks to Docker!\n"
    }
,
    {
        "ref": "https://harrylee.me/blog/2016-06-20-how-to-use-phpstorm-to-debug-remote-docker-container/",
        "title": "Docker: How to use PhpStorm to debug remote Docker container for Web Development using Xdebug",
        "section": "blog",
        "tags": ["docker","phpstorm","debug"],
        "date" : "2016.06.20",
        "body": "There are many tools that can be used for debugging when developing a web app using PHP. These debugging tools are very useful in a local development environment, you can view the states of variables, indicate line breaks etc. However, these tools become difficult to use when you decide to include Docker in your workflow.\nThis post outlines the configuration needed to incorporate the debugging power of the PhpStorm IDE to your PHP based web app. We will not be using the official Docker Support in PhpStorm. This is because we are not integrating PhpStorm fully with Docker, we are merely using PhpStorm for debugging purposes.\nThis post assumes you have the following set up:\n Using Docker (with the official PHP image) Using PhpStorm (version 10.0.*) Using Docker in a VirtualBox setup either using docker-machine or an Ubuntu VM.  My Set Up The following describes my set up of the development environment. You do not need to use the exact set up, but the configuration to follow assume that you are using this set up.\n A local VirtualBox VM running Ubuntu 16.04 Xenial with the latest docker-engine installed. I did not opt to run Docker using Docker for Mac or Docker Toolbox, I just ssh into my Ubuntu VM and run docker natively from there. My docker containers are based on the LAMP stack. I have PhpStorm installed on my host (not my VM). The PhpStorm project is located in a local folder on my host. This local folder is then mounted as a shared folder on the VirtualBox VM. So changes I make to this folder is reflected in the VM and vice versa. In the VM, this shared folder is also mounted as a volume on the docker container. So: changes in code in PhpStorm is reflected in the VM and hence reflected in the docker container.  Configuration With the above set up, we essentially want to use PhpStorm to debug a remote server.\nThe configuration used in this set up is essentially a summary from these two sources:\n Debug your PHP in Docker with Intellij/PHPStorm and Xdebug Debug your PHP in Docker with Intellij/PHPStorm and Xdebug (forked from the above)    Create your own Dockerfile with your own configuration and add the below to install Xdebug:\n FROM php:5 ... RUN yes | pecl install xdebug \\ \u0026amp;\u0026amp; echo \u0026quot;zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)\u0026quot; \u0026gt; /usr/local/etc/php/conf.d/xdebug.ini \\ \u0026amp;\u0026amp; echo \u0026quot;xdebug.remote_enable=on\u0026quot; \u0026gt;\u0026gt; /usr/local/etc/php/conf.d/xdebug.ini \\ \u0026amp;\u0026amp; echo \u0026quot;xdebug.remote_autostart=off\u0026quot; \u0026gt;\u0026gt; /usr/local/etc/php/conf.d/xdebug.ini   Build your image\n  Start a container with your image but with the following environment variables:\n XDEBUG_CONFIG: \u0026quot;remote_host=10.0.2.2\u0026quot; PHP_IDE_CONFIG: \u0026quot;serverName=my.local\u0026quot; You can either the run the container with the -e option or in a docker-compose.yml file.    In PhpStorm go to Languages \u0026amp; Frameworks \u0026gt; PHP \u0026gt; Servers \u0026gt; and set the following:  Name should match PHP_IDE_CONFIG previously set You can modify the Host and Port to your own settings (the hostname that you use to ssh to the VM)    All set!\n  Usage  Set a break point in your code base in PhpStorm. Access the web page on your local machine. On the web page navigate to the section where it will trigger the break point. The web page will begin loading and PhpStorm will prompt for your attention. On first run, PhpStorm will ask you to map the directories. Follow the prompts and you are done!  "
    }
]
